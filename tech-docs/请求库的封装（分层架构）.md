# è¯·æ±‚åº“çš„å°è£…

## 1. ç®€ä»‹

### èƒŒæ™¯

è™½ç„¶å‰ç«¯å…·æœ‰è¯¸å¤šæˆç†Ÿçš„è¯·æ±‚åº“ï¼Œä½†åœ¨å®é™…é¡¹ç›®å¼€å‘ä¸­å‘ç°ï¼Œå®ƒä»¬å¾ˆéš¾å®Œå…¨å¥‘åˆå®é™…çš„å¼€å‘éœ€æ±‚ã€‚

**axios**

axios è™½ç„¶å¾ˆæˆç†Ÿï¼Œä½†å®ƒåªæ˜¯ä¸€ä¸ªåŸºç¡€åº“ï¼Œæ²¡æœ‰æä¾›è¯¸å¤šçš„ä¸Šå±‚åŠŸèƒ½ï¼Œæ¯”å¦‚ï¼š

1. è¯·æ±‚é‡è¯•
2. è¯·æ±‚ç¼“å­˜
3. è¯·æ±‚å¹‚ç­‰
4. è¯·æ±‚ä¸²è¡Œ
5. è¯·æ±‚å¹¶å‘
6. ...

**VueRequest / SWR**

å®ƒä»¬è™½ç„¶æä¾›çš„åŠŸèƒ½å¾ˆå¤šï¼Œä½†ä»ç„¶å­˜åœ¨è¯¸å¤šé—®é¢˜ï¼š

1. ä¸ä¸Šå±‚æ¡†æ¶è¿‡åº¦ç»‘å®šå¯¼è‡´å¼€å‘åœºæ™¯å—é™ï¼Œä¹Ÿæ— æ³•æä¾›ç»Ÿä¸€çš„ API
2. æˆç†Ÿåº¦ä¸å¤Ÿï¼Œissue çš„å›å¤ä¹Ÿéš¾ä»¥åšåˆ°åŠæ—¶ï¼Œå­˜åœ¨ä¸€å®šé£é™©
3. å®ƒä»¬æ²¡æœ‰èšåˆåŸºç¡€è¯·æ±‚åº“ï¼Œä»ç„¶éœ€è¦æ‰‹åŠ¨æ•´åˆ

**é™¤æ­¤ä¹‹å¤–æ›´é‡è¦çš„æ˜¯**

å…¬å…±åº“ä¸åŒ…å«å…¬å¸å†…éƒ¨åˆ¶å®šçš„åè®®è§„èŒƒï¼Œå³ä¾¿ä½¿ç”¨å…¬å…±åº“ï¼Œä¹Ÿå¿…é¡»é’ˆå¯¹å®ƒä»¬åšäºŒæ¬¡å°è£…ã€‚

**ç»¼ä¸Šï¼Œéœ€è¦è‡ªè¡Œå°è£…ä¸€å¥—é€‚é…å…¬å¸ä¸šåŠ¡çš„å‰ç«¯è¯·æ±‚åº“**

## 2. æŠ€æœ¯æ ˆä¸ç¯å¢ƒ

- **åŒ…ç®¡ç†å™¨:** pnpm (åˆ©ç”¨å…¶ workspace åŠŸèƒ½ç®¡ç†å¤šåŒ…é¡¹ç›®)
- **è¯­è¨€:** TypeScript (æä¾›ç±»å‹å®‰å…¨å’Œæ¥å£å®šä¹‰èƒ½åŠ›)
- **æ„å»ºå·¥å…·:** tsup (ç”¨äºæ„å»º ESM å’Œ CommonJS åŒæ ¼å¼è¾“å‡º)
- **æ ¸å¿ƒä¾èµ–:**
  - `axios` (å¯é€‰ï¼Œä½œä¸ºåº•å±‚è¯·æ±‚å®ç°)
  - `fetch` API (åŸç”Ÿæµè§ˆå™¨ APIï¼Œæ— éœ€é¢å¤–ä¾èµ–)
- **å¼€å‘ç¯å¢ƒ:** Node.js (LTS ç‰ˆæœ¬), pnpm
- **æ¼”ç¤ºå·¥å…·:** Vite (ç”¨äºæµè§ˆå™¨æ¼”ç¤ºåº”ç”¨)

## 3. åº“ç»“æ„çš„å®è§‚è®¾è®¡ï¼ˆæ¶æ„è®¾è®¡ï¼‰

### åˆå§‹è®¾è®¡

![](https://cdn.nlark.com/yuque/0/2025/png/2894784/1756821951876-8d02c479-e059-43a2-a356-84a3a3e194cf.png)

æ•´ä¸ªåº“ç»“æ„åŒ…å«ä¸‰å±‚ï¼Œä»ä¸‹å¾€ä¸Šä¾æ¬¡æ˜¯ï¼š

- `è¯·æ±‚å®ç°å±‚ï¼ˆrequest-impï¼‰`ï¼š æä¾›è¯·æ±‚åŸºæœ¬åŠŸèƒ½
- `request-core`ï¼š æä¾›ç½‘ç»œä¸Šå±‚æ§åˆ¶ï¼Œæ¯”å¦‚è¯·æ±‚ä¸²è¡Œã€è¯·æ±‚å¹¶è¡Œã€è¯·æ±‚é‡è¯•ã€è¯·æ±‚é˜²é‡ç­‰åŠŸèƒ½
- `request-bus`ï¼š ä¸ºè¯·æ±‚ç»‘å®šä¸šåŠ¡åŠŸèƒ½ï¼Œè¯¥å±‚æ¥å…¥å…¬å¸å†…éƒ¨åè®®è§„èŒƒå’Œæ¥å£æ–‡æ¡£ï¼Œå‘å¤–æä¾›ä¸šåŠ¡æ¥å£ API

> å±‚æ˜¯ä¸€ç§å¯¹ä»£ç ç»“æ„çš„é€»è¾‘åˆ’åˆ†ï¼Œåœ¨å…·ä½“å®ç°ä¸Šå¯ä»¥æœ‰å¤šç§æ–¹å¼ï¼š
>
> - æ¯ä¸ªå±‚ä¸€ä¸ª monorepo å­åŒ…
> - æ¯ä¸ªå±‚ä¸€ä¸ªå­æ–‡ä»¶å¤¹
> - ...

### **<font style="color:rgb(0, 0, 0);">ä¼˜åŒ–è®¾è®¡**

åœ¨ä¸‰å±‚ä¸­ï¼Œè¯·æ±‚å®ç°å±‚çš„å®ç°æœ‰å¤šç§æ–¹å¼ï¼š

- åŸºäº`fetch`åŸç”Ÿ
- åŸºäº`axios`ç­‰ç¬¬ä¸‰æ–¹åº“
- ...

<font style="color:rgb(51, 51, 51);">è¿™ç§å®ç°çš„å¤šæ ·æ€§å¯èƒ½å¯¼è‡´è¿™ä¸€æ¬¡å±‚çš„ä¸ç¨³å®šï¼Œè€Œ`request-imp`<font style="color:rgb(51, 51, 51);">æ˜¯åŸºç¡€å±‚ï¼Œå®ƒçš„ä¸ç¨³æ€§ä¼šä¼ å¯¼åˆ°ä¸Šä¸€å±‚ã€‚

<font style="color:rgb(51, 51, 51);">æ‰€<font style="color:rgb(51, 51, 51);">ä»¥å¿…é¡»å¯»æ±‚ä¸€ç§æ–¹æ¡ˆæ¥éš”ç¦»è¿™ç§ä¸ç¨³å®šæ€§ã€‚

<font style="color:rgb(51, 51, 51);">æˆ‘ä»¬å¯ä»¥åŸºäº DIPï¼ˆDependence Inversion Principleï¼Œä¾èµ–å€’ç½®åŸåˆ™ï¼‰ï¼Œå½»åº•å°†`request-core`<font style="color:rgb(51, 51, 51);">å’Œè¯·æ±‚çš„å®ç°è§£è€¦ï¼Œè€Œ`typescript`<font style="color:rgb(51, 51, 51);">çš„ç±»å‹ç³»ç»Ÿè®©è¿™ä¸€åˆ‡çš„è½åœ°æˆä¸ºäº†å¯èƒ½ã€‚

<font style="color:rgb(51, 51, 51);">äºæ˜¯ç»“æ„æ¼”å˜ä¸ºï¼š

![](https://cdn.nlark.com/yuque/0/2025/png/2894784/1756822612156-994a83ec-68d1-462c-b9d6-9e663293efaa.png)

ä¸‹é¢æ˜¯ç¤ºæ„ä»£ç ï¼š

### `request-core`ï¼š**æ ¸å¿ƒå±‚**

æ ¸å¿ƒå±‚å®šä¹‰äº†è¯·æ±‚è€… (Requestor) çš„æŠ½è±¡æ¥å£ï¼Œå¹¶æä¾›ä¸€ä¸ªä¾èµ–æ­¤æ¥å£çš„é«˜çº§åŠŸèƒ½ç±» RequestCore

```typescript
/**
 * @description è¯·æ±‚é…ç½®æ¥å£
 */
export interface RequestConfig {
  url: string
  method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH'
  data?: any
  headers?: Record<string, string>
  timeout?: number
}

/**
 * @description è¯·æ±‚è€…æ¥å£ï¼Œå®šä¹‰äº†å‘é€è¯·æ±‚çš„æ ‡å‡†åŒ–å¥‘çº¦ã€‚
 * request-imp-* æ¨¡å—éœ€è¦å®ç°æ­¤æ¥å£ã€‚
 */
export interface Requestor {
  request<T = any>(config: RequestConfig): Promise<T>
}

/**
 * @description é‡è¯•é…ç½®
 */
export interface RetryConfig {
  retries: number
  delay?: number
}

/**
 * @description ç¼“å­˜é…ç½®
 */
export interface CacheConfig {
  ttl?: number // ç¼“å­˜æ—¶é—´(ms)
  key?: string // è‡ªå®šä¹‰ç¼“å­˜key
}

/**
 * @description æ ¸å¿ƒå±‚ï¼Œå°è£…ä¸å…·ä½“å®ç°æ— å…³çš„é«˜çº§åŠŸèƒ½ã€‚
 */
export class RequestCore {
  private retryFeature: RetryFeature
  private cacheFeature: CacheFeature

  /**
   * é€šè¿‡ä¾èµ–æ³¨å…¥æ¥æ”¶ä¸€ä¸ªå®ç°äº† Requestor æ¥å£çš„å®ä¾‹ã€‚
   * @param requestor å…·ä½“çš„è¯·æ±‚å®ç°è€…ã€‚
   */
  constructor(private requestor: Requestor) {
    this.retryFeature = new RetryFeature(requestor)
    this.cacheFeature = new CacheFeature(requestor)
  }

  /**
   * åŸºç¡€è¯·æ±‚æ–¹æ³•
   */
  async request<T>(config: RequestConfig): Promise<T> {
    return this.requestor.request<T>(config)
  }

  /**
   * GET è¯·æ±‚
   */
  async get<T>(url: string, config?: Partial<RequestConfig>): Promise<T> {
    return this.request<T>({ url, method: 'GET', ...config })
  }

  /**
   * POST è¯·æ±‚
   */
  async post<T>(url: string, data?: any, config?: Partial<RequestConfig>): Promise<T> {
    return this.request<T>({ url, method: 'POST', data, ...config })
  }

  /**
   * PUT è¯·æ±‚
   */
  async put<T>(url: string, data?: any, config?: Partial<RequestConfig>): Promise<T> {
    return this.request<T>({ url, method: 'PUT', data, ...config })
  }

  /**
   * DELETE è¯·æ±‚
   */
  async delete<T>(url: string, config?: Partial<RequestConfig>): Promise<T> {
    return this.request<T>({ url, method: 'DELETE', ...config })
  }

  /**
   * å¸¦é‡è¯•çš„è¯·æ±‚
   */
  async requestWithRetry<T>(config: RequestConfig, retryConfig?: RetryConfig): Promise<T> {
    return this.retryFeature.requestWithRetry<T>(config, retryConfig)
  }

  /**
   * å¸¦é‡è¯•çš„ GET è¯·æ±‚
   */
  async getWithRetry<T>(url: string, retries: number = 3): Promise<T> {
    return this.requestWithRetry<T>({ url, method: 'GET' }, { retries })
  }

  /**
   * å¸¦ç¼“å­˜çš„è¯·æ±‚
   */
  async requestWithCache<T>(config: RequestConfig, cacheConfig?: CacheConfig): Promise<T> {
    return this.cacheFeature.requestWithCache<T>(config, cacheConfig)
  }

  /**
   * å¸¦ç¼“å­˜çš„ GET è¯·æ±‚
   */
  async getWithCache<T>(url: string, cacheConfig?: CacheConfig): Promise<T> {
    return this.requestWithCache<T>({ url, method: 'GET' }, cacheConfig)
  }

  /**
   * æ¸…é™¤ç¼“å­˜
   */
  clearCache(key?: string): void {
    this.cacheFeature.clearCache(key)
  }
}
```

### `request-imp-*`**å®ç°å±‚**

è¿™é‡Œæä¾›ä¸¤ä¸ªå…·ä½“çš„å®ç°ï¼šrequest-axios-imp å’Œ request-fetch-impã€‚å®ƒä»¬éƒ½å®ç°äº† request-core ä¸­å®šä¹‰çš„ Requestor æ¥å£

```typescript
import axios, { AxiosRequestConfig } from 'axios'
import { Requestor } from './request-core'

/**
 * @description åŸºäº Axios çš„ Requestor æ¥å£å®ç°ã€‚
 */
export class AxiosRequestor implements Requestor {
  async request<T>(config: {
    url: string
    method: string
    data?: any
  }): Promise<T> {
    const axiosConfig: AxiosRequestConfig = {
      url: config.url,
      method: config.method as any,
      data: config.data,
    }
    console.log('[Imp] ä½¿ç”¨ Axios å‘é€è¯·æ±‚...')
    const response = await axios.request(axiosConfig)
    return response.data as T
  }
}
```

```typescript
import { Requestor } from './request-core'

/**
 * @description åŸºäº Fetch API çš„ Requestor æ¥å£å®ç°ã€‚
 */
export class FetchRequestor implements Requestor {
  async request<T>(config: {
    url: string
    method: string
    data?: any
  }): Promise<T> {
    const fetchOptions: RequestInit = {
      method: config.method,
      headers: {
        'Content-Type': 'application/json',
      },
      body: config.data ? JSON.stringify(config.data) : null,
    }
    console.log('[Imp] ä½¿ç”¨ Fetch API å‘é€è¯·æ±‚...')
    const response = await fetch(config.url, fetchOptions)
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`)
    }
    return (await response.json()) as T
  }
}
```

### `request-bus`**ä¸šåŠ¡å±‚**

ä¸šåŠ¡å±‚æä¾›äº† RequestBus ç±»æ¥ç®¡ç† API çš„æ³¨å†Œå’Œé…ç½®ï¼Œæ”¯æŒåŠ¨æ€åˆ‡æ¢åº•å±‚å®ç°ã€‚

```typescript
/**
 * @description è¯·æ±‚å®ç°ç±»å‹
 */
export type RequestImplementation = 'axios' | 'fetch'

/**
 * @description é…ç½®ç±»ï¼Œè´Ÿè´£é€‰æ‹©å¹¶æ³¨å…¥å…·ä½“çš„å®ç°
 */
export class RequestConfig {
  private static instance: RequestCore

  /**
   * åˆ›å»ºè¯·æ±‚æ ¸å¿ƒå®ä¾‹
   * @param implementation é€‰æ‹©çš„å®ç°æ–¹å¼
   */
  static createRequestCore(implementation: RequestImplementation = 'axios'): RequestCore {
    if (!this.instance) {
      let requestor

      switch (implementation) {
        case 'axios':
          console.log('[Config] ä½¿ç”¨ Axios å®ç°')
          requestor = new AxiosRequestor()
          break
        case 'fetch':
          console.log('[Config] ä½¿ç”¨ Fetch å®ç°')
          requestor = new FetchRequestor()
          break
        default:
          throw new Error(`ä¸æ”¯æŒçš„å®ç°æ–¹å¼: ${implementation}`)
      }

      this.instance = new RequestCore(requestor)
    }

    return this.instance
  }

  /**
   * è·å–å½“å‰å®ä¾‹
   */
  static getInstance(): RequestCore {
    if (!this.instance) {
      return this.createRequestCore()
    }
    return this.instance
  }

  /**
   * é‡ç½®å®ä¾‹ï¼ˆç”¨äºåˆ‡æ¢å®ç°ï¼‰
   */
  static reset(): void {
    this.instance = null as any
  }
}

/**
 * @description ä¸šåŠ¡å±‚ API é›†åˆ
 */
class RequestBus {
  private apiMap: Map<string, any> = new Map()

  register(name: string, apiClass: any): any {
    if (!name) {
      throw new Error('name is required')
    }
    if (!apiClass) {
      throw new Error('apiClass is required')
    }
    if (this.apiMap.has(name)) {
      throw new Error(`${name} already registered`)
    }

    const apiInstance = new apiClass(RequestConfig.getInstance())
    this.apiMap.set(name, apiInstance)
    return apiInstance
  }

  /**
   * åˆ‡æ¢è¯·æ±‚å®ç°
   * @param implementation å®ç°æ–¹å¼
   */
  switchImplementation(implementation: RequestImplementation): void {
    RequestConfig.reset()
    RequestConfig.createRequestCore(implementation)

    this.apiMap.forEach((api) => {
      api.requestCore = RequestConfig.getInstance()
    })
  }

  /**
   * æ¸…é™¤ç¼“å­˜
   * @param key ç¼“å­˜é”®
   */
  clearCache(key?: string): void {
    RequestConfig.getInstance().clearCache(key)
  }

  /**
   * æ¸…é™¤æ‰€æœ‰ç¼“å­˜
   */
  clearAllCache(): void {
    RequestConfig.getInstance().clearCache()
  }
}

// åˆ›å»ºå¹¶å¯¼å‡ºå•ä¾‹
export const requestBus = new RequestBus()
```

### **ä½¿ç”¨ç¤ºä¾‹ (æµè§ˆå™¨æ¼”ç¤º)**

åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬å¯ä»¥åŠ¨æ€æ³¨å†Œå’Œç®¡ç†ä¸šåŠ¡ APIï¼š

```javascript
// æ³¨å†Œç”¨æˆ· API
class UserApi {
  constructor(requestCore) {
    this.requestCore = requestCore
  }

  async getUserInfo(userId) {
    const url = `https://jsonplaceholder.typicode.com/users/${userId}`
    // ä½¿ç”¨å¸¦é‡è¯•çš„è¯·æ±‚
    const userInfo = await this.requestCore.getWithRetry(url, 2)
    return {
      ...userInfo,
      fetchTime: new Date().toISOString(),
    }
  }

  async getUserList() {
    const url = 'https://jsonplaceholder.typicode.com/users'
    // ä½¿ç”¨å¸¦ç¼“å­˜çš„è¯·æ±‚ï¼Œç¼“å­˜ 2 åˆ†é’Ÿ
    return this.requestCore.getWithCache(url, { ttl: 2 * 60 * 1000 })
  }
}

// æ³¨å†Œåˆ° RequestBus
const userApi = requestBus.register('user', UserApi)

// ä½¿ç”¨ API
async function main() {
  try {
    console.log('--- å¼€å§‹è°ƒç”¨ä¸šåŠ¡ API ---')
    const user = await userApi.getUserInfo('1')
    console.log('--- ä¸šåŠ¡ API è°ƒç”¨æˆåŠŸ ---')
    console.log('è·å–åˆ°çš„ç”¨æˆ·æ•°æ®:', user)

    // åŠ¨æ€åˆ‡æ¢å®ç°
    requestBus.switchImplementation('fetch')
    console.log('--- å·²åˆ‡æ¢åˆ° Fetch å®ç° ---')
  } catch (error) {
    console.error('--- ä¸šåŠ¡ API è°ƒç”¨å¤±è´¥ ---')
    console.error('æœ€ç»ˆé”™è¯¯:', error)
  }
}

main()
```

### **æ¶æ„å›¾**

![](https://cdn.nlark.com/yuque/__mermaid_v3/c6640e7585132c65347eed6d694507f0.svg)

### **æ ¸å¿ƒç†å¿µ**

1. **åˆ†å±‚æ¶æ„**
   - `request-imp-*`: æä¾›å…·ä½“çš„ HTTP è¯·æ±‚å‘é€èƒ½åŠ› (å¦‚ `request-imp-axios`, `request-imp-fetch`)ã€‚å®ƒä»¬å®ç°ç»Ÿä¸€çš„ `Requestor` æ¥å£
   - `request-core`: æ ¸å¿ƒå±‚ï¼Œå®šä¹‰ `Requestor` æ¥å£ï¼Œå¹¶åŸºäºæ­¤æ¥å£æä¾›ç¼“å­˜ã€é‡è¯•ç­‰ä¸å…·ä½“å®ç°æ— å…³çš„é«˜çº§åŠŸèƒ½ã€‚é€šè¿‡ä¾èµ–æ³¨å…¥æ¥æ”¶ `request-imp` çš„å…·ä½“å®ç°
   - `request-bus`: ä¸šåŠ¡å±‚ï¼Œæä¾› `RequestBus` ç±»æ¥ç®¡ç† API æ³¨å†Œï¼Œæ”¯æŒåŠ¨æ€åˆ‡æ¢åº•å±‚å®ç°ï¼Œå¹¶é›†æˆä¸šåŠ¡é€»è¾‘

2. **ä¾èµ–å€’ç½® (DIP)**
   - `request-core` ä¸ç›´æ¥ä¾èµ–å…·ä½“çš„å®ç° (axios/fetch)ï¼Œè€Œæ˜¯ä¾èµ–æŠ½è±¡çš„ `Requestor` æ¥å£ã€‚å…·ä½“å®ç° (`request-imp-*`) åè¿‡æ¥ä¾èµ–ï¼ˆå®ç°ï¼‰è¿™ä¸ªæ¥å£ã€‚è¿™ä½¿å¾—åº•å±‚å®ç°å¯ä»¥è½»æ¾æ›¿æ¢ï¼Œè€Œä¸å½±å“æ ¸å¿ƒå±‚å’Œä¸šåŠ¡å±‚ã€‚

3. **å½“å‰å®ç°çš„åŠŸèƒ½**
   - âœ… **è¯·æ±‚é‡è¯•**: æ”¯æŒé…ç½®é‡è¯•æ¬¡æ•°å’Œå»¶è¿Ÿæ—¶é—´
   - âœ… **è¯·æ±‚ç¼“å­˜**: å†…å­˜ç¼“å­˜ï¼Œæ”¯æŒ TTL å’Œè‡ªå®šä¹‰ç¼“å­˜é”®
   - âœ… **åŸºç¡€è¯·æ±‚æ–¹æ³•**: GET, POST, PUT, DELETE
   - âœ… **ç±»å‹å®‰å…¨**: å®Œæ•´çš„ TypeScript ç±»å‹å®šä¹‰
   - âœ… **å®ç°åˆ‡æ¢**: è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢ axios/fetch å®ç°
   - âœ… **API ç®¡ç†**: é€šè¿‡ RequestBus æ³¨å†Œå’Œç®¡ç†ä¸šåŠ¡ API

## 4. **é¡¹ç›®ç»“æ„å›¾**

```plain
â”œâ”€â”€ packages/                             // pnpm monorepo çš„æ ¸å¿ƒç›®å½•ï¼Œå­˜æ”¾æ‰€æœ‰å­åŒ…
â”‚   â”œâ”€â”€ request-core/                     // æ ¸å¿ƒå±‚åŒ…ï¼šå®šä¹‰æ¥å£å’Œå®ç°ä¸å…·ä½“è¯·æ±‚åº“æ— å…³çš„é«˜çº§åŠŸèƒ½
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â”œâ”€â”€ features/                 // å­˜æ”¾é«˜çº§åŠŸèƒ½çš„å…·ä½“å®ç°
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ cache.ts              // åŠŸèƒ½ï¼šè¯·æ±‚ç¼“å­˜ï¼ˆå†…å­˜ç¼“å­˜ï¼‰
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ retry.ts              // åŠŸèƒ½ï¼šè¯·æ±‚å¤±è´¥é‡è¯•
â”‚   â”‚   â”‚   â”œâ”€â”€ core.ts                   // RequestCore ç±»ï¼šç»„åˆæ‰€æœ‰ featureï¼Œæä¾›ç»Ÿä¸€çš„é«˜çº§ API
â”‚   â”‚   â”‚   â”œâ”€â”€ interface.ts              // å®šä¹‰ Requestor æŠ½è±¡æ¥å£ï¼Œæ˜¯ä¾èµ–å€’ç½®çš„æ ¸å¿ƒ
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                  // åŒ…çš„å…¥å£æ–‡ä»¶ï¼Œå¯¼å‡ºå…¬å…± API å’Œç±»å‹
â”‚   â”‚   â”œâ”€â”€ package.json                  // request-core åŒ…çš„é…ç½®æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ tsconfig.json                 // TypeScript é…ç½®æ–‡ä»¶
â”‚   â”‚
â”‚   â”œâ”€â”€ request-imp-axios/                // å®ç°å±‚åŒ…ï¼šåŸºäº Axios
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                  // å®ç° Requestor æ¥å£çš„ AxiosRequestor ç±»
â”‚   â”‚   â”œâ”€â”€ package.json                  // ä¾èµ– axios å’Œ request-core
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â”œâ”€â”€ request-imp-fetch/                // å®ç°å±‚åŒ…ï¼šåŸºäº Fetch API
â”‚   â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”‚   â””â”€â”€ index.ts                  // å®ç° Requestor æ¥å£çš„ FetchRequestor ç±»
â”‚   â”‚   â”œâ”€â”€ package.json                  // ä¾èµ– request-core
â”‚   â”‚   â””â”€â”€ tsconfig.json
â”‚   â”‚
â”‚   â””â”€â”€ request-bus/                      // ä¸šåŠ¡å±‚åŒ…ï¼šç»„è£…å’Œæš´éœ²ç»™åº”ç”¨çš„æœ€ç»ˆ API
â”‚       â”œâ”€â”€ src/
â”‚       â”‚   â”œâ”€â”€ config.ts                 // é…ç½®ç±»ï¼šé€‰æ‹©å¹¶æ³¨å…¥å…·ä½“çš„ imp å®ç° (axios/fetch)
â”‚       â”‚   â””â”€â”€ index.ts                  // RequestBus ç±»ï¼šAPI æ³¨å†Œå’Œç®¡ç†ï¼Œç»Ÿä¸€å¯¼å‡º
â”‚       â”œâ”€â”€ package.json                  // ä¾èµ– request-core å’Œæ‰€æœ‰ request-imp-* åŒ…
â”‚       â””â”€â”€ tsconfig.json
â”‚
â”œâ”€â”€ apps/                                 // å­˜æ”¾ä½¿ç”¨è¯¥è¯·æ±‚åº“çš„ç¤ºä¾‹åº”ç”¨æˆ–çœŸå®é¡¹ç›®
â”‚   â””â”€â”€ demo-browser/                     // æµè§ˆå™¨æ¼”ç¤ºåº”ç”¨
â”‚       â”œâ”€â”€ api/                          // ä¸šåŠ¡ API å®šä¹‰
â”‚       â”‚   â”œâ”€â”€ user.js                   // ç”¨æˆ·ç›¸å…³ API
â”‚       â”‚   â””â”€â”€ post.js                   // æ–‡ç« ç›¸å…³ API
â”‚       â”œâ”€â”€ index.html                    // HTML é¡µé¢
â”‚       â”œâ”€â”€ main.js                       // åº”ç”¨ä¸»æ–‡ä»¶ï¼Œæ¼”ç¤ºå„ç§åŠŸèƒ½
â”‚       â”œâ”€â”€ package.json                  // ä¾èµ– request-bus
â”‚       â””â”€â”€ vite.config.js                // Vite é…ç½®
â”‚
â”œâ”€â”€ .gitignore
â”œâ”€â”€ package.json                          // Monorepo æ ¹ package.jsonï¼Œç®¡ç† workspaces å’Œ scripts
â”œâ”€â”€ pnpm-workspace.yaml                   // pnpm çš„ workspace é…ç½®æ–‡ä»¶ï¼Œå£°æ˜ packages ç›®å½•
â””â”€â”€ tsconfig.json                         // Monorepo æ ¹ TS é…ç½®æ–‡ä»¶ï¼Œä¸ºæ‰€æœ‰å­åŒ…æä¾›åŸºç¡€é…ç½®
```

## 5. æ„å»ºå’Œå‘å¸ƒ

### æ„å»ºè„šæœ¬

æ ¹ç›®å½•ä¸‹çš„æ„å»ºè„šæœ¬ä¼šè‡ªåŠ¨æ„å»ºæ‰€æœ‰åŒ…ï¼š

```bash
# æ„å»ºæ‰€æœ‰åŒ…
pnpm run build

# æ„å»ºæµè§ˆå™¨æ¼”ç¤ºåº”ç”¨
pnpm run build:browser

# å¼€å‘æ¨¡å¼
pnpm run dev

# å¯åŠ¨æµè§ˆå™¨æ¼”ç¤º
pnpm run demo:browser
```

### åŒ…æ„å»ºé…ç½®

æ¯ä¸ªåŒ…éƒ½é…ç½®äº†åŒæ ¼å¼è¾“å‡ºï¼š

- **ESM æ ¼å¼**: `dist/index.js` - ç°ä»£æµè§ˆå™¨å’Œ Node.js æ”¯æŒ
- **CommonJS æ ¼å¼**: `dist/cjs/index.js` - å…¼å®¹æ€§æ›´å¥½çš„æ ¼å¼
- **ç±»å‹å®šä¹‰**: `dist/index.d.ts` - TypeScript ç±»å‹æ”¯æŒ

### å‘å¸ƒç­–ç•¥

1. **ç§æœ‰ä»“åº“å‘å¸ƒ**: å°†æ ¸å¿ƒåŒ…å‘å¸ƒåˆ°ç§æœ‰ npm ä»“åº“
2. **workspace ä¾èµ–**: ä½¿ç”¨ `workspace:*` åœ¨ monorepo å†…éƒ¨å¼•ç”¨
3. **ç‰ˆæœ¬ç®¡ç†**: é€šè¿‡ `package.json` ä¸­çš„ version å­—æ®µç®¡ç†ç‰ˆæœ¬

## 6. æœªæ¥æ‰©å±•è®¡åˆ’

è™½ç„¶å½“å‰ç‰ˆæœ¬å·²ç»å®ç°äº†æ ¸å¿ƒåŠŸèƒ½ï¼Œä½†æ ¹æ®æ–‡æ¡£çš„åŸå§‹è§„åˆ’ï¼Œè¿˜æœ‰ä»¥ä¸‹åŠŸèƒ½å¯ä»¥åç»­æ·»åŠ ï¼š

### ğŸš§ è®¡åˆ’ä¸­çš„åŠŸèƒ½

1. **è¯·æ±‚å¹¶å‘æ§åˆ¶**
   - é™åˆ¶æœ€å¤§å¹¶å‘è¯·æ±‚æ•°
   - è¯·æ±‚é˜Ÿåˆ—ç®¡ç†
   - ä¼˜å…ˆçº§é˜Ÿåˆ—

2. **è¯·æ±‚ä¸²è¡Œæ‰§è¡Œ**
   - ä¿è¯è¯·æ±‚é¡ºåºæ‰§è¡Œ
   - ä¸²è¡Œé˜Ÿåˆ—ç®¡ç†
   - ä¾èµ–å…³ç³»å¤„ç†

3. **è¯·æ±‚å¹‚ç­‰æ€§**
   - é˜²æ­¢é‡å¤è¯·æ±‚
   - è¯·æ±‚å»é‡æœºåˆ¶
   - åŸºäºè¯·æ±‚å†…å®¹çš„å“ˆå¸Œ

4. **æ›´ä¸°å¯Œçš„ç¼“å­˜ç­–ç•¥**
   - localStorage ç¼“å­˜
   - IndexedDB ç¼“å­˜
   - ç¼“å­˜åŒæ­¥ç­–ç•¥

5. **è¯·æ±‚æ‹¦æˆªå™¨å’Œå“åº”æ‹¦æˆªå™¨**
   - è¯·æ±‚é¢„å¤„ç†
   - å“åº”åå¤„ç†
   - é”™è¯¯ç»Ÿä¸€å¤„ç†

### ğŸ”§ æ‰©å±•æ–¹å¼

åœ¨ `request-core/src/features/` ç›®å½•ä¸‹æ·»åŠ æ–°çš„åŠŸèƒ½æ¨¡å—ï¼š

```typescript
// ç¤ºä¾‹ï¼šå¹¶å‘æ§åˆ¶åŠŸèƒ½
export class ConcurrencyFeature {
  constructor(private requestor: Requestor) {}

  async requestWithConcurrency<T>(
    config: RequestConfig,
    options: ConcurrencyOptions
  ): Promise<T> {
    // å®ç°å¹¶å‘æ§åˆ¶é€»è¾‘
  }
}
```

ç„¶ååœ¨ `RequestCore` ç±»ä¸­é›†æˆæ–°åŠŸèƒ½ï¼š

```typescript
export class RequestCore {
  private concurrencyFeature: ConcurrencyFeature

  constructor(requestor: Requestor) {
    this.concurrencyFeature = new ConcurrencyFeature(requestor)
  }

  async requestWithConcurrency<T>(
    config: RequestConfig,
    options?: ConcurrencyOptions
  ): Promise<T> {
    return this.concurrencyFeature.requestWithConcurrency<T>(config, options)
  }
}
```

è¿™ç§æ¨¡å—åŒ–çš„è®¾è®¡ä½¿å¾—æ–°åŠŸèƒ½çš„æ·»åŠ éå¸¸ä¾¿æ·ä¸”ä¸ä¼šå½±å“ç°æœ‰ä»£ç ã€‚
