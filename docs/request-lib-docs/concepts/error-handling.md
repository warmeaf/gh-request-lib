# 错误处理

## 📖 概述

本请求库提供了完善的错误处理机制，包括统一的错误分类、智能的错误建议以及灵活的错误拦截和恢复策略。

## 🎯 核心特性

1. **统一错误格式**：基于 `RequestError` 类的一致结构
2. **智能错误分类**：8种错误类型自动推断
3. **详细上下文信息**：包含URL、方法、时间戳等
4. **自动建议生成**：为每种错误提供解决建议
5. **错误拦截机制**：支持自定义错误处理
6. **错误恢复策略**：集成重试和失败回调

## 🏗️ RequestError 类

### 核心属性

```typescript
export class RequestError extends Error {
  readonly type: RequestErrorType        // 错误类型
  readonly context: RequestErrorContext  // 错误上下文  
  readonly suggestion?: string           // 解决建议
  readonly status?: number               // HTTP状态码
  readonly originalError?: unknown       // 原始错误
}
```

### 主要方法

- `toDisplayMessage()`: 格式化用户友好的错误信息
- `toJSON()`: 转换为JSON格式用于日志记录
- **自动类型推断**: 根据错误信息自动判断错误类型
- **智能建议生成**: 为不同错误类型提供相应解决建议

## 🔍 错误类型分类

### 8种错误类型

1. **NETWORK_ERROR** - 网络连接错误、DNS解析失败、CORS跨域错误
   - 建议：请检查网络连接或服务器是否可访问

2. **HTTP_ERROR** - 4xx、5xx HTTP状态码错误
   - 401：认证失败，请检查token或登录状态
   - 404：请检查请求URL是否正确
   - 500：服务器错误，请稍后重试或联系管理员

3. **TIMEOUT_ERROR** - 请求超时、手动取消
   - 建议：可以尝试增加timeout值或检查网络状况

4. **VALIDATION_ERROR** - 配置参数无效、必填字段缺失
   - 建议：请检查请求配置参数是否正确

5. **CACHE_ERROR** - 缓存操作错误
6. **CONCURRENT_ERROR** - 并发控制错误  
7. **RETRY_ERROR** - 重试逻辑错误
8. **UNKNOWN_ERROR** - 未知错误

## 🛠️ ErrorHandler 工具类

### 核心功能

- **wrapError()** - 将任意错误包装为标准 RequestError
- **createHttpError()** - 创建HTTP状态码错误
- **createNetworkError()** - 创建网络连接错误  
- **createTimeoutError()** - 创建超时错误

### 智能类型推断

根据错误消息内容自动推断错误类型：
- 包含'network'、'fetch'、'connection' → NETWORK_ERROR
- 包含'timeout'、AbortError → TIMEOUT_ERROR
- HTTP状态码 → HTTP_ERROR

## 🔧 错误拦截器

### 拦截器机制

错误拦截器按注册顺序执行，可以修改错误信息或执行恢复逻辑：

```typescript
interface RequestInterceptor {
  onError?: (error: RequestError, config: RequestConfig) => RequestError | Promise<RequestError>
}
```

### 常见应用场景

#### 认证错误处理
- 捕获401错误，自动刷新token
- 刷新失败时跳转登录页

#### 业务错误转换
- 将HTTP错误转换为业务友好的错误信息
- 添加业务上下文和解决建议

#### 错误监控统计
- 记录错误发生频率和类型
- 关键错误自动告警

#### 错误降级处理
- 网络错误时使用缓存数据
- 提供默认数据作为降级方案

## 🔄 错误恢复策略

### 重试机制

**智能重试条件**：
- 网络错误和5xx错误自动重试
- 指数退避策略，避免服务器压力
- 支持自定义重试条件和延迟配置

### 断路器模式

**三种状态管理**：
- **CLOSED** - 正常执行请求
- **OPEN** - 错误过多，拒绝请求
- **HALF_OPEN** - 尝试恢复，探测服务可用性

### 超时退避

**自适应超时**：
- 根据历史失败情况动态调整超时时间
- 成功后逐步恢复到正常超时值

## 📊 错误监控和调试

### 错误收集与统计

**核心指标**：
- 错误总数和错误率
- 按类型分组的错误统计
- 按状态码分组的错误统计
- 失败最多的URL排行

**实时监控**：
- 自动收集错误信息和请求上下文
- 支持时间范围筛选
- 提供可视化错误趋势

### 调试支持

- **详细错误日志**：包含完整的错误栈和上下文
- **性能影响分析**：错误对请求性能的影响统计
- **单元测试支持**：提供错误模拟和验证工具

## ✅ 最佳实践

### 分层错误处理
1. **网络层**：连接、超时等基础错误
2. **协议层**：HTTP状态码错误
3. **业务层**：业务逻辑错误
4. **展示层**：用户界面错误

### 用户体验原则
- **优雅降级**：提供备选方案和默认数据
- **清晰反馈**：明确的错误信息和解决建议  
- **快速恢复**：通过重试和断路器快速恢复
- **渐进增强**：根据网络状况调整功能

## 🔍 总结

### 核心优势
1. **统一错误格式**：基于 RequestError 的一致结构
2. **智能错误分类**：8种错误类型自动推断
3. **完整上下文信息**：请求信息和执行上下文
4. **自动建议生成**：每种错误类型提供解决建议
5. **灵活拦截机制**：支持自定义错误处理策略
6. **完善监控能力**：错误收集、统计和可视化

### 设计理念
- **错误即数据**：将错误视为有价值的数据
- **快速失败恢复**：早发现、早处理、早恢复
- **用户体验优先**：始终考虑用户体验影响
- **高可维护性**：清晰的错误分类和处理流程