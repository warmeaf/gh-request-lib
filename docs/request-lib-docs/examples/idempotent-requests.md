# å¹‚ç­‰è¯·æ±‚ç¤ºä¾‹

## ğŸ”’ ä»€ä¹ˆæ˜¯å¹‚ç­‰è¯·æ±‚ï¼Ÿ

å¯¹å®Œå…¨ç›¸åŒçš„è¯·æ±‚ï¼ˆæ–¹æ³•ã€URLã€å‚æ•°ã€æ•°æ®ã€æŒ‡å®šè¯·æ±‚å¤´ï¼‰åœ¨ä¸€å®šæ—¶é—´å†…åªæ‰§è¡Œä¸€æ¬¡ï¼Œåç»­ç›¸åŒè¯·æ±‚ç›´æ¥è¿”å›ç»“æœã€‚åœ¨ Web åº”ç”¨ä¸­ï¼Œå¹‚ç­‰æ€§ä¸»è¦ç”¨äºï¼š

- **é˜²é‡å¤æäº¤**: é˜²æ­¢ç”¨æˆ·å¿«é€Ÿç‚¹å‡»æŒ‰é’®å¯¼è‡´çš„é‡å¤æ“ä½œ
- **ç¼“å­˜ä¼˜åŒ–**: ç›¸åŒè¯·æ±‚çš„ç»“æœå¯ä»¥è¢«ç¼“å­˜å’Œé‡ç”¨
- **ç½‘ç»œä¿æŠ¤**: å‡å°‘ä¸å¿…è¦çš„ç½‘ç»œè¯·æ±‚ï¼Œæå‡æ€§èƒ½

## ğŸ“ POST å¹‚ç­‰è¯·æ±‚æ¼”ç¤º

æ¼”ç¤ºå¦‚ä½•ä½¿ç”¨ POST å¹‚ç­‰è¯·æ±‚é˜²æ­¢é‡å¤æäº¤è¡¨å•æ•°æ®ã€‚

**æ“ä½œæŒ‡å—**ï¼š
- å¿«é€Ÿå¤šæ¬¡ç‚¹å‡»"å¹‚ç­‰æäº¤"æŒ‰é’®ï¼Œè§‚å¯Ÿè¯·æ±‚å»é‡æ•ˆæœ
- **é¦–æ¬¡è¯·æ±‚**ï¼šå‘èµ·ç½‘ç»œè¯·æ±‚å¹¶ç¼“å­˜ç»“æœ
- **ç¼“å­˜å‘½ä¸­**ï¼šç›´æ¥è¿”å›ç¼“å­˜ç»“æœ
- **è¯·æ±‚å¤ç”¨**ï¼šç­‰å¾…æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚å®Œæˆ
- **ä¿æŠ¤æœŸ**ï¼š5ç§’å†…ç›¸åŒè¯·æ±‚ä¼šè¢«å»é‡

:::preview POST å¹‚ç­‰è¯·æ±‚ || é˜²é‡å¤æäº¤æ¼”ç¤º

demo-preview=./components/idempotent-requests/post.vue

:::

## ğŸ“Š GET å¹‚ç­‰è¯·æ±‚æ¼”ç¤º

å±•ç¤ºå¦‚ä½•ä½¿ç”¨ GET å¹‚ç­‰è¯·æ±‚é¿å…é‡å¤çš„æ•°æ®æŸ¥è¯¢ï¼Œæå‡åº”ç”¨æ€§èƒ½ã€‚

**æ“ä½œæŒ‡å—**ï¼š
- å¿«é€Ÿå¤šæ¬¡ç‚¹å‡»"å¹‚ç­‰æŸ¥è¯¢"æŒ‰é’®ï¼Œè§‚å¯Ÿè¯·æ±‚å»é‡æ•ˆæœ
- **ç¼“å­˜å‘½ä¸­**ï¼šç›´æ¥è¿”å›ç¼“å­˜ç»“æœ
- **è¯·æ±‚å¤ç”¨**ï¼šç­‰å¾…æ­£åœ¨è¿›è¡Œçš„è¯·æ±‚
- **ç½‘ç»œè¯·æ±‚**ï¼šå‘èµ·æ–°çš„ç½‘ç»œè¯·æ±‚
- **ä¿æŠ¤æœŸ**ï¼š8ç§’å†…ç›¸åŒè¯·æ±‚ä¼šè¢«å»é‡

:::preview GET å¹‚ç­‰è¯·æ±‚ || é˜²é‡å¤æŸ¥è¯¢æ¼”ç¤º

demo-preview=./components/idempotent-requests/get.vue

:::

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§è¯¦è§£

### ğŸ”’ é˜²é‡å¤æäº¤æœºåˆ¶

- **æ™ºèƒ½é”®ç”Ÿæˆ**: åŸºäºè¯·æ±‚æ–¹æ³•ã€URLã€å‚æ•°ã€æ•°æ®å’ŒæŒ‡å®šè¯·æ±‚å¤´ç”Ÿæˆå”¯ä¸€é”®
- **æ—¶é—´çª—å£æ§åˆ¶**: å¯é…ç½®çš„å¹‚ç­‰ä¿æŠ¤æ—¶é—´ï¼ˆé»˜è®¤ 30 ç§’ï¼‰
- **é‡å¤è¯·æ±‚æ‹¦æˆª**: åœ¨ä¿æŠ¤æœŸå†…çš„é‡å¤è¯·æ±‚ä¼šè¢«è‡ªåŠ¨æ‹¦æˆª
- **å›è°ƒé€šçŸ¥**: å¯é…ç½®é‡å¤è¯·æ±‚å‘ç”Ÿæ—¶çš„å›è°ƒå‡½æ•°

### ğŸ“Š æ€§èƒ½ä¼˜åŒ–

- **å†…å­˜ç¼“å­˜**: åŸºäºé«˜æ•ˆçš„å†…å­˜ç¼“å­˜å®ç°
- **é”®å€¼å‹ç¼©**: æ”¯æŒå¤šç§å“ˆå¸Œç®—æ³•ï¼ˆfnv1aã€xxhashã€simpleï¼‰
- **è‡ªåŠ¨æ¸…ç†**: è¿‡æœŸè¯·æ±‚ä¼šè¢«è‡ªåŠ¨æ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼
- **ç»Ÿè®¡ç›‘æ§**: è¯¦ç»†çš„æ€§èƒ½ç»Ÿè®¡ä¿¡æ¯

### ğŸ”§ é…ç½®é€‰é¡¹

```javascript
import { createApiClient } from 'request-api'
import { fetchRequestor } from 'request-imp-fetch'

// å®šä¹‰ API ç±» - æ”¯æŒå¹‚ç­‰è¯·æ±‚
class PostApi {
  constructor(requestCore) {
    this.requestCore = requestCore
  }

  // æ™®é€š POST è¯·æ±‚
  async createPost(postData) {
    return this.requestCore.post('/posts', postData)
  }

  // å¹‚ç­‰ POST è¯·æ±‚ - é˜²é‡å¤æäº¤
  async createPostIdempotent(postData, idempotentConfig = {}) {
    return this.requestCore.postIdempotent(
      '/posts',
      postData,
      {},
      {
        ttl: 30000, // 30ç§’å¹‚ç­‰ä¿æŠ¤æœŸ
        includeHeaders: ['authorization', 'content-type'],
        onDuplicate: (original, duplicate) => {
          console.log('Duplicate request blocked:', duplicate)
        },
        ...idempotentConfig,
      }
    )
  }
}

// åˆ›å»º API å®¢æˆ·ç«¯
const apiClient = createApiClient(
  { post: PostApi },
  {
    requestor: fetchRequestor,
    globalConfig: {
      timeout: 10000,
      debug: true,
    },
  }
)

// ä½¿ç”¨å¹‚ç­‰è¯·æ±‚
try {
  // ç¬¬ä¸€æ¬¡è¯·æ±‚ - æ­£å¸¸æ‰§è¡Œ
  const result1 = await apiClient.post.createPostIdempotent({
    title: 'Test Post',
    body: 'Content',
  })

  // ç«‹å³å†æ¬¡è¯·æ±‚ - è¢«æ‹¦æˆªï¼Œè¿”å›ç¼“å­˜ç»“æœ
  const result2 = await apiClient.post.createPostIdempotent({
    title: 'Test Post',
    body: 'Content',
  })

  console.log(
    'Same result:',
    JSON.stringify(result1) === JSON.stringify(result2)
  )
} catch (error) {
  console.error('Request failed:', error)
}
```

### ğŸš€ æ”¯æŒçš„è¯·æ±‚æ–¹æ³•

å¹‚ç­‰è¯·æ±‚åŠŸèƒ½æ”¯æŒæ‰€æœ‰ HTTP æ–¹æ³•ï¼š

- **GET**: `getIdempotent()` - é˜²é‡å¤æŸ¥è¯¢
- **POST**: `postIdempotent()` - é˜²é‡å¤æäº¤
- **PUT**: `putIdempotent()` - é˜²é‡å¤æ›´æ–°
- **PATCH**: `patchIdempotent()` - é˜²é‡å¤éƒ¨åˆ†æ›´æ–°

### ğŸ“‹ é…ç½®å‚æ•°è¯´æ˜

| å‚æ•°                | ç±»å‹     | é»˜è®¤å€¼                            | è¯´æ˜                              |
| ------------------- | -------- | --------------------------------- | --------------------------------- |
| `ttl`               | number   | 30000                             | å¹‚ç­‰ä¿æŠ¤æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰              |
| `key`               | string   | è‡ªåŠ¨ç”Ÿæˆ                          | è‡ªå®šä¹‰å¹‚ç­‰é”®                      |
| `includeHeaders`    | string[] | ['content-type', 'authorization'] | å‚ä¸å¹‚ç­‰åˆ¤æ–­çš„è¯·æ±‚å¤´              |
| `includeAllHeaders` | boolean  | false                             | æ˜¯å¦åŒ…å«æ‰€æœ‰è¯·æ±‚å¤´                |
| `hashAlgorithm`     | string   | 'fnv1a'                           | å“ˆå¸Œç®—æ³•ï¼ˆfnv1aã€xxhashã€simpleï¼‰ |
| `onDuplicate`       | function | undefined                         | é‡å¤è¯·æ±‚å›è°ƒå‡½æ•°                  |

### ğŸ“ˆ ç»Ÿè®¡ä¿¡æ¯

å¹‚ç­‰è¯·æ±‚æä¾›è¯¦ç»†çš„ç»Ÿè®¡ä¿¡æ¯ï¼š

```javascript
const stats = apiClient.post.requestCore.getIdempotentStats()
console.log(stats)
// {
//   totalRequests: 100,
//   duplicatesBlocked: 25,
//   duplicateRate: 25.0,
//   avgResponseTime: 150,
//   cacheHitRate: 25.0,
//   keyGenerationTime: 2
// }
```

### ğŸŒŸ ä½¿ç”¨åœºæ™¯

1. **è¡¨å•æäº¤**: é˜²æ­¢ç”¨æˆ·å¿«é€Ÿç‚¹å‡»å¯¼è‡´çš„é‡å¤æäº¤
2. **æ•°æ®æŸ¥è¯¢**: é¿å…çŸ­æ—¶é—´å†…çš„é‡å¤æŸ¥è¯¢ï¼Œæå‡æ€§èƒ½
3. **æ”¯ä»˜æ“ä½œ**: ç¡®ä¿æ”¯ä»˜è¯·æ±‚çš„å¹‚ç­‰æ€§ï¼Œé¿å…é‡å¤æ‰£æ¬¾
4. **åˆ›å»ºæ“ä½œ**: é˜²æ­¢é‡å¤åˆ›å»ºç›¸åŒçš„èµ„æº
5. **æ›´æ–°æ“ä½œ**: ç¡®ä¿æ›´æ–°æ“ä½œçš„ä¸€è‡´æ€§

### âš ï¸ æ³¨æ„äº‹é¡¹

1. **TTL è®¾ç½®**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚åˆç†è®¾ç½®å¹‚ç­‰ä¿æŠ¤æ—¶é—´
2. **å†…å­˜ä½¿ç”¨**: å¤§é‡å¹‚ç­‰è¯·æ±‚ä¼šå ç”¨å†…å­˜ï¼Œæ³¨æ„ç›‘æ§
3. **é”®å†²çª**: ä¸åŒè¯·æ±‚å¯èƒ½ç”Ÿæˆç›¸åŒçš„é”®ï¼Œéœ€è¦åˆç†é…ç½®å‚æ•°
4. **å¼‚å¸¸å¤„ç†**: å¹‚ç­‰è¯·æ±‚å¤±è´¥ä¸ä¼šè¢«ç¼“å­˜ï¼Œä¸‹æ¬¡è¯·æ±‚ä¼šé‡æ–°æ‰§è¡Œ

### ğŸ† æœ€ä½³å®è·µ

1. **åˆç†è®¾ç½® TTL**: æ ¹æ®æ“ä½œç±»å‹è®¾ç½®åˆé€‚çš„ä¿æŠ¤æ—¶é—´
2. **ç›‘æ§ç»Ÿè®¡ä¿¡æ¯**: å®šæœŸæ£€æŸ¥å¹‚ç­‰ç»Ÿè®¡ï¼Œä¼˜åŒ–é…ç½®
3. **é”™è¯¯å¤„ç†**: ä¸ºå¹‚ç­‰è¯·æ±‚æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†
4. **ç”¨æˆ·åé¦ˆ**: åœ¨é‡å¤è¯·æ±‚è¢«æ‹¦æˆªæ—¶ç»™ç”¨æˆ·é€‚å½“çš„åé¦ˆ
